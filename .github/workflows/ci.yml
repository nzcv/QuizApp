name: ci
on:
  push:
    branches: master
    paths-ignore:
      - README.md
      - README_CN.md
      - LICENSE
  pull_request:
    paths-ignore:
      - README.md
      - README_CN.md
      - LICENSE

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Setup Flutter
        uses: subosito/flutter-action@v2  # ä½¿ç”¨ v2 ç‰ˆæœ¬çš„ Flutter action
        with:
            channel: stable
            flutter-version: 3.13.9
      # - name: Set up Java
      #   uses: actions/setup-java@v4
      #   with:
      #     distribution: zulu
      #     java-version: 11
      - name: Build Flutter application for Android
        run: flutter build apk --target-platform=android-arm64
      - name: Notify Feishu on Status Change
        if: always()
        env:
          FEISHU_WEBHOOK: "https://open.feishu.cn/open-apis/bot/v2/hook/03d57580-5e06-4ac2-8263-3f1927219fd6"
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          MESSAGE='{
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": { "tag": "plain_text", "content": "ðŸ”„ Workflow ${{ job.status }}" },
                "template": "${{ job.status == 'success' && 'green' || 'red' }}"
              },
              "elements": [{
                "tag": "div",
                "text": {
                  "tag": "lark_md",
                  "content": "**Workflow:** ${{ github.workflow }}\n**Branch:** ${{ github.ref_name }}\n**Status:** ${{ job.status }}\n**Triggered by:** ${{ github.actor }}"
                }
              }, {
                "tag": "action",
                "actions": [{
                  "tag": "button",
                  "text": { "tag": "plain_text", "content": "View Run" },
                  "url": "${{ env.RUN_URL }}",
                  "type": "primary"
                }]
              }]
            }
          }'
          curl -X POST -H "Content-Type: application/json" -d "$MESSAGE" "$FEISHU_WEBHOOK"      
      - name: Rename arm64-v8a APK
        run: mv build/app/outputs/flutter-apk/app-release.apk android-arm64-v8a.apk      
      - name: Upload arm64-v8a APK
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64-v8a.apk
          path: android-arm64-v8a.apk      
